<!doctype html>

<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1">
<link rel="alternate"  href="http://dustinfarris.com/feeds/all.atom.xml" type="application/atom+xml" title="Dustin Farris Full Atom Feed">
<title>"Setting up a PostgreSQL Server with Gentoo"</title>
<script>
WebFontConfig = {
google: { families: [ 'Dosis:600:latin', 'Open+Sans:400italic,400,700:latin' ] }
};
(function() {
 var wf = document.createElement('script');
 wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
 '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
 wf.type = 'text/javascript';
 wf.async = 'true';
 var s = document.getElementsByTagName('script')[0];
 s.parentNode.insertBefore(wf, s);
 })();
</script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
<link rel="stylesheet" href="http://dustinfarris.com/theme/css/pure.css"><link rel="stylesheet" href="http://dustinfarris.com/theme/css/pygments.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta
name="description"
content="Dustin Farris">
<link href="http://dustinfarris.com/humans.txt" rel="author">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
<div class="pure-g-r" id="layout">
<div class="sidebar pure-u">
  <div class="cover-img" style="background-image: url('http://dustinfarris.com/images/beach.jpg')">
    <div class="cover-body">
      <header class="header">
        <hgroup>
        <a href="http://dustinfarris.com">
          <img class="avatar" src="http://dustinfarris.com/images/dustin.jpeg">
        </a>
        <h1 class="brand-main"><a href="http://dustinfarris.com">Dustin Farris</a></h1>
        <p class="tagline">inveniam viam aut faciam</p>
        <p class="social">
        <a href="https://github.com/dustinfarris/">
          <i class="fa fa-github fa-3x"></i>
        </a>
        <a href="https://twitter.com/dustinfarris">
          <i class="fa fa-twitter fa-3x"></i>
        </a>
        <a href="/feeds/all.atom.xml">
          <i class="fa fa-rss fa-3x"></i>
        </a>
        </p>
        </hgroup>
      </header>
    </div>
  </div>
</div><div class="pure-u">
  <div class="content">
    <article
      class="post"
      role="main"
      itemscope
      itemprop="mainContentOfPage"
      itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 itemprop="name">"Setting up a PostgreSQL Server with Gentoo"</h1>
        <div class="lead" itemprop="description"><p>Setting up a database server is usually the first step when deploying a web framework stack.  This is the second of <a href="http://dustinfarris.com/tag/setting-up-gentoo-postgres-and-django/">three documents</a> showing how to get Django up and running with Gentoo.</p>
<p><a id="contents"></a></p>
<h2>Contents</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#firewall">Firewall</a></li>
<li><a href="#install-postgres">Install Postgres</a></li>
<li><a href="#install-postgis-extensions">Install PostGIS Extensions</a></li>
<li><a href="#create-super-users">Create Super Users</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<p><a id="introduction"></a></p>
<h2>Introduction</h2>
<p>Using Gentoo Linux ...</p></div>
      </header>
      <footer>
        <p class="post-meta">
        <a class="post-tag" href="http://dustinfarris.com/tag/gentoo.html">Gentoo</a>
        </p>
      </footer>
      <div itemprop="articleBody">
        <p>Setting up a database server is usually the first step when deploying a web framework stack.  This is the second of <a href="http://dustinfarris.com/tag/setting-up-gentoo-postgres-and-django/">three documents</a> showing how to get Django up and running with Gentoo.</p>
<p><a id="contents"></a></p>
<h2>Contents</h2>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#firewall">Firewall</a></li>
<li><a href="#install-postgres">Install Postgres</a></li>
<li><a href="#install-postgis-extensions">Install PostGIS Extensions</a></li>
<li><a href="#create-super-users">Create Super Users</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<p><a id="introduction"></a></p>
<h2>Introduction</h2>
<p>Using Gentoo Linux to run PostgreSQL is a great marriage of technologies ready to meet and exceed the demands of most web applications.  Getting up and running is a breeze, and thanks to Gentoo's Portage packaging system, you can run multiple major versions of Postgres seamlessly on the same machine.  This document describes the basic PostgreSQL server installation requirements you should have in place when preparing to deploy a Django project.  Note this only describes the database <em>server</em> side of Postgres.</p>
<p><a href="#contents">Contents</a></p>
<p><a id="prerequisites"></a></p>
<h2>Prerequisites</h2>
<ul>
<li>Gentoo Linux (see my <a href="http://dustinfarris.com/2012/2/setting-up-a-gentoo-server/">guide on setting up Gentoo</a>)</li>
<li>Root access</li>
</ul>
<p><a href="#contents">Contents</a></p>
<p><a id="firewall"></a></p>
<h2>Firewall</h2>
<p>If Postgres will be running on a separate server from your applications, you will have to open the Postgres port on your firewall.  If Postgres is running on the same machine as your applications, you can skip this section.</p>
<p>Edit both <code>/etc/iptables.up.config</code> and <code>/etc/ip6tables.up.config</code> adding this line somewhere before the final "reject all" line:</p>
<div class="highlight"><pre><span class="c"># PostgreSQL server</span>
-A INPUT -p tcp -m state --state NEW --dport <span class="m">5432</span> -j ACCEPT
</pre></div>


<p>Save and restart iptables:</p>
<div class="highlight"><pre><span class="go">iptables-restore &lt; /etc/iptables.up.config</span>
<span class="go">ip6tables-restore &lt; /etc/ip6tables.up.config</span>
<span class="go">/etc/init.d/iptables save</span>
<span class="go">/etc/init.d/ip6tables save</span>
<span class="go">/etc/init.d/iptables restart</span>
<span class="go">/etc/init.d/ip6tables restart</span>
</pre></div>


<p><a href="#contents">Contents</a></p>
<p><a id="install-postgres"></a></p>
<h2>Install Postgres</h2>
<p>The portage package with default USE flags is appropriate for our installation, so just emerge Postgres.</p>
<div class="highlight"><pre><span class="go">emerge dev-db/postgresql-server</span>
</pre></div>


<p>Since Django and most other web frameworks are pushing everything to be UTF-8 encoded, it's best if the database server starts doing so from the beginning.  Before creating a database, find and change (or add if missing) a line in <code>/etc/conf.d/postgresql-9.1</code>.</p>
<div class="highlight"><pre><span class="nv">PG_INITDB_OPTS</span><span class="o">=</span><span class="s2">&quot;--locale=en_US.UTF-8&quot;</span>
</pre></div>


<p>Now create a database.  The exact command for this depends on the version of Postgres that got installed, and portage will have outputted the command needed.  If this is lost in your console history, you can always retrieve it from the logs:</p>
<div class="highlight"><pre><span class="go">grep &quot;config =dev-db/postgres&quot; /var/log/portage/elog/summary.log</span>
</pre></div>


<p>As of this writing, the current version of Postgres installed on a stable hardened profile is 9.1.4, so the command run is this:</p>
<div class="highlight"><pre><span class="go">emerge --config =dev-db/postgresql-server-9.1.4</span>
</pre></div>


<p>This sets up a fresh database in <code>/var/lib/postgresql/9.1/</code> called <code>data</code>.  Now make any edits you need to <code>/etc/postgresql-9.1/postgresql.conf</code>.  The defaults are probably fine, I just make sure the following are set:</p>
<div class="highlight"><pre><span class="nv">lc_messages</span> <span class="o">=</span> <span class="s1">&#39;en_US.UTF-8&#39;</span>
<span class="nv">lc_monetary</span> <span class="o">=</span> <span class="s1">&#39;en_US.UTF-8&#39;</span>
<span class="nv">lc_numeric</span> <span class="o">=</span> <span class="s1">&#39;en_US.UTF-8&#39;</span>
<span class="nv">lc_time</span> <span class="o">=</span> <span class="s1">&#39;en_US.UTF-8&#39;</span>
</pre></div>


<p>Finally, if this server will be separate from the application server, you will need to explicitly tell Postgres to allow connections form your application server.  In <code>/etc/postgresql-9.1/postgresql.conf</code>, be sure that the <code>listen_addresses</code> variable contains the IP address postgres should listen on. e.g.:</p>
<div class="highlight"><pre>listen_addresses = &#39;localhost, 192.168.0.120&#39;
</pre></div>


<p>Additional security-related configurations are found in <code>/etc/postgresql-9.1/pg_hba.conf</code>.  If needed, add this line toward the bottom (substituting your application server's IP address):</p>
<div class="highlight"><pre>host  all  all  156.123.456.12  trust
</pre></div>


<p>Now, just start the database server and tell Gentoo to start it on boot.</p>
<div class="highlight"><pre><span class="go">/etc/init.d/postgresql-9.1 start</span>
<span class="go">rc-update add postgresql-9.1 default</span>
</pre></div>


<p><a href="#contents">Contents</a></p>
<p><a id="install-postgis-extensions"></a></p>
<h2>Install PostGIS Extensions</h2>
<p><a href="http://postgis.refractions.net/">PostGIS</a> is a set of spatial extensions to support geographic objects in PostgreSQL.  There is a chance you may not need this right away, but it is extremely handy to have readily available when you do.  I recommend installing these extensions whether you foresee actually using them or not.</p>
<p>First, install the <a href="http://www.gdal.org/">GDAL</a> dependency:</p>
<div class="highlight"><pre><span class="go">emerge gdal -avq</span>
</pre></div>


<p>Before installing PostGIS, I find that it helps to "version lock" the installation as a major upgrade may break your applications without some TLC.  To do this, find the current version Portage is installing <a href="http://gentoo-portage.com/dev-db/postgis">here</a> and add an appropriate line to <code>/etc/portage/package.mask</code>.  I use PostGIS 1.5.3, but PostGIS was recently upgraded to 2.0.  This breaks my applications, so I want to hold off on that upgrade for now.  I added this line to <code>/etc/portage/package.mask</code>:</p>
<div class="highlight"><pre>&gt;<span class="o">=</span>dev-db/postgis-2.0.0
</pre></div>


<p>which tells Portage not to install any version of PostGIS equal to or greater than 2.0.0.  Now, emerge PostGIS.</p>
<div class="highlight"><pre><span class="go">emerge postgis -avq</span>
</pre></div>


<p>As you'll probably see in the output, PostGIS requires some painless configuration before it is ready to be installed into your database.  Find and edit these two lines in <code>/etc/postgis_dbs</code>:</p>
<div class="highlight"><pre><span class="nv">templates</span><span class="o">=(</span><span class="s2">&quot;template_postgis&quot;</span><span class="o">)</span>
<span class="nv">configured</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>
</pre></div>


<p>Install PostGIS into your database; like Postgres, the exact command here depends on the exact version of PostGIS you installed.  If you forgot, just run:</p>
<div class="highlight"><pre><span class="go">grep &quot;config =dev-db/postgis&quot; /var/log/portage/elog/summary.log</span>
</pre></div>


<p>For me, the command is:</p>
<div class="highlight"><pre><span class="go">emerge --config =dev-db/postgis-1.5.3-r1</span>
</pre></div>


<p>With PostGIS now installed, you will will be able to create "spatially enabled" databases using <code>createdb -T template_postgis mydb</code>.  For more information, see the <a href="http://postgis.refractions.net/documentation/">PostGIS documentation</a>.</p>
<p><a href="#contents">Contents</a></p>
<p><a id="create-super-users"></a></p>
<h2>Create Super Users</h2>
<p>It makes life easier if each system user using Postgres has a corresponding Postgres superuser.  The two primary users of Postgres on my machine are <code>dustin</code> (my personal account) and <code>web</code> for web applications.</p>
<div class="highlight"><pre><span class="go">usermod -aG postgres dustin</span>
<span class="go">usermod -aG postgres web</span>
<span class="go">su - postgres</span>
<span class="go">createuser -s dustin</span>
<span class="go">createuser -s web</span>
</pre></div>


<p>Now, when you switch two either of these accounts, you can run administrative commands (<code>createdb</code>, <code>dropdb</code>, etc..) painlessly.</p>
<p><a href="#contents">Contents</a></p>
<p><a id="conclusion"></a></p>
<h2>Conclusion</h2>
<p>If all went well, you now have a running PostgreSQL server ready to start accepting connections.  If you have any issues getting of the ground, feel free to comment here and/or email me.</p>
<p><a href="#contents">Contents</a></p>
      </div>
    </article>
    <a href="#" class="go-top">&uparrow;</a>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = "dustinfarris"; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
<footer class="footer">
  <p>&copy; Dustin Farris</p>
</footer>  </div>
</div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script>
var $top = $('.go-top');

// Show or hide the sticky footer button
$(window).scroll(function() {
    if ($(this).scrollTop() > 200) {
    $top.fadeIn(200);
    } else {
    $top.fadeOut(200);
    }
    });

// Animate the scroll to top
$top.click(function(event) {
    event.preventDefault();
    $('html, body').animate({scrollTop: 0}, 300);
    })

// Makes sure that the href="#" attached to the <a> elements
// don't scroll you back up the page.
$('body').on('click', 'a[href="#"]', function(event) {
    event.preventDefault();
    });
</script><script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js">
</script>
<script>
$(document).ready(function(){
  $(".content").fitVids();
});
</script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-13275015-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>

</body>

</html>