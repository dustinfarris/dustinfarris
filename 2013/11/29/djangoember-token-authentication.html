<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dustin Farris, inveniam viam aut faciam">

        <link rel="alternate"  href="http://dustinfarris.com/feeds/all.atom.xml" type="application/atom+xml" title="Dustin Farris Full Atom Feed"/>

        <title>Django/Ember Token Authentication // Dustin Farris // inveniam viam aut faciam</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://dustinfarris.com/theme/css/pure.css">
    <link rel="stylesheet" href="http://dustinfarris.com/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <div class="cover-img" style="background-image: url('http://dustinfarris.com/images/beach.jpg')">
                <div class="cover-body">
                    <header class="header">
                        <hgroup>
                            <img class="avatar" src="http://dustinfarris.com/images/dustin.jpeg">
                            <h1 class="brand-main"><a href="http://dustinfarris.com">Dustin Farris</a></h1>
                            <p class="tagline">inveniam viam aut faciam</p>
                                <p class="social">
                                    <a href="https://github.com/dustinfarris/">
                                        <i class="fa fa-github fa-3x"></i>
                                    </a>
                                    <a href="https://twitter.com/dustinfarris">
                                        <i class="fa fa-twitter fa-3x"></i>
                                    </a>
                                    <a href="/feeds/all.atom.xml">
                                        <i class="fa fa-rss fa-3x"></i>
                                    </a>
                                </p>
                        </hgroup>
                    </header>
                </div>
            </div>
        </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Django/Ember Token Authentication</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="http://dustinfarris.com/tag/django.html">Django</a>
                                <a class="post-category" href="http://dustinfarris.com/tag/ember.html">Ember</a>
                        </p>
                </header>
            </section>
            <p>As I've <a href="/2013/09/21/django-ember-authentication-is-easy.html">previously detailed</a>, 
implementing session-based authentication with Django and Ember is not as hard as you might think.
Now I'd like to say the same thing for token-based authentication.</p>
<p>In token-based authentication, every user in the database is assigned a unique token.  The flow of 
authentication then works like this:</p>
<ol>
<li>You send a username and password to the API</li>
<li>The API validates the credentials and returns that user's token</li>
<li>You include the token in the header of every request going forward to prove that you are already 
   authenticated.</li>
</ol>
<p>Here's a demonstration of the concept using curl:</p>
<div class="highlight"><pre><span class="nv">$ </span>curl localhost:8000/users/
<span class="o">{</span><span class="s2">&quot;detail&quot;</span>: <span class="s2">&quot;Authentication credentials were not provided.&quot;</span><span class="o">}</span>

<span class="nv">$ </span>curl -X POST -d <span class="s2">&quot;username=bob&amp;password=correct&quot;</span> localhost:8000/api-token-auth/
<span class="o">{</span><span class="s2">&quot;token&quot;</span>: <span class="s2">&quot;abcdefg12345&quot;</span><span class="o">}</span>

<span class="nv">$ </span>curl -H <span class="s2">&quot;Authorization: Token abcdefg12345&quot;</span> localhost:8000/users/
<span class="o">[{</span><span class="s2">&quot;id&quot;</span>: 1, <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;bob&quot;</span>, <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;bob@example.org&quot;</span><span class="o">}]</span>
</pre></div>


<p>Here, I'll explain how to set up token-based authentication using Django REST Framework, and how to 
set up Ember as a consumer.  I'll assume you already have DRF installed, and that you have <a href="https://docs.djangoproject.com/en/dev/topics/auth/customizing/#extending-the-existing-user-model">extended 
Django's User model</a> 
(which I really recommend you do from the beginning even if you don't have an immediate need), e.g.:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractUser</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>


<h2>Django (DRF)</h2>
<p>After installing DRF in the usual way, you will want need a way to generate tokens for your users, 
and return them when a consumer posts valid credentials.  Fortunately, DRF has most of this 
functionality <a href="http://django-rest-framework.org/api-guide/authentication#tokenauthentication">built in</a>.<br />
First, add <code>rest_framework.authtoken</code> to your <code>INSTALLED_APPS</code>:</p>
<div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;rest_framework.authtoken&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>


<p>Run <code>manage.py syncdb</code>.  Refer to the <a href="http://django-rest-framework.org/api-guide/authentication#schema-migrations">DRF documentation</a> 
for possible edge cases involving South migrations.  Finally, create tokens for all existing users 
in the Python shell:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">rest_framework.authtoken.models</span> <span class="kn">import</span> <span class="n">Token</span>
<span class="kn">from</span> <span class="nn">users.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</pre></div>


<h3>Automating token creation</h3>
<p>Going forward, you'll want to automate the creation of tokens for new users.  This is easily 
achieved with a post_save hook for the User model.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span> <span class="nn">rest_framework.authtoken.models</span> <span class="kn">import</span> <span class="n">Token</span>

<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">init_new_user</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an authentication token for newly created users.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
</pre></div>


<h3>Authentication endpoint</h3>
<p>DRF takes care of authenticating credentials and returning a token.  You just need to add the 
endpoint to your URLconf:</p>
<div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^api-token-auth/&#39;</span><span class="p">,</span> <span class="s">&#39;rest_framework.authtoken.views.obtain_auth_token&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>


<h3>Token-based policy</h3>
<p>The last piece as far as Django is concerned is specifying that you want to use token-based 
authentication throughout your REST API.  This can be done by adding/modifying the 
<code>DEFAULT_AUTHENTICATION</code> setting:</p>
<div class="highlight"><pre><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">&#39;rest_framework.authentication.TokenAuthentication&#39;</span><span class="p">,</span>
        <span class="s">&#39;rest_framework.authentication.SessionAuthentication&#39;</span><span class="p">,</span>  <span class="c"># optional</span>
    <span class="p">),</span>
<span class="p">}</span>
</pre></div>


<p>I keep SessionAuthentication for using the web-browsable API that DRF comes with.</p>
<h3>The current user</h3>
<p>Thinking ahead, we know that in Ember, after authenticating, we will want an easy way to retrieve details 
about the authenticated user.  Things like, name, email, etc..  The DRF response to a correct username 
and password is: a token.  While the token helps us authenticate future requests, it tells us nothing
about the user we just authenticated.  We can't even do a GET request to /users/:id/ because we don't
even know what the user's ID is!  To solve this problem, I like to create a special endpoint that returns 
the currently authenticated user at /users/me/.  This is easy to accomplish in DRF.  In your UserViewSet:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">UserViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">User</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>

    <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If provided &#39;pk&#39; is &quot;me&quot; then return the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pk</span> <span class="o">==</span> <span class="s">&#39;me&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">UserSerializer</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UserViewSet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>
</pre></div>


<p>That's it for setting up Django.</p>
<h2>Ember</h2>
<p>As explained above, to make use of token authentication, we'll need to send a username and password 
to the API, store the returned token, and provide the token in the header for any future request to 
the API.  In short, we need:</p>
<ul>
<li>A user model to store user data</li>
<li>An authentication controller to facilitate the exchange of credentials for a token and store the 
  currently authenticated user</li>
<li>A way to prevent an unauthenticated user from visiting protected pages</li>
</ul>
<p>The model is straight-forward:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">username</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nx">first_name</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nx">last_name</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nx">is_active</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;boolean&#39;</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>


<p>Of course your model may be different depending on how you've extended the User Django model.</p>
<h3>AuthController</h3>
<p>The real meat of token authentication in Ember lies in a controller we'll create to submit form 
information (username/password) to the server, retrieve the token, store the token, and provide 
information about the currently logged in user.  To accomplish this, we'll extend ObjectController, 
so that the controller itself represents the logged in user (or lack thereof).  Remember that 
ObjectControllers in Ember are manifestations of a model—just as ArrayControllers are manifestations 
of a set of models, etc.</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">AuthController</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectController</span><span class="p">.</span><span class="nx">extend</span><span class="p">();</span>
</pre></div>


<p>I'm going to digress and talk for a second on Django, Ember, and forms.  In Ember, form fields can 
be tied to controller attributes.  In Django, forms are validated and if they are not valid, a set 
of errors is returned.  In this case we will be submitting form data to Django REST Framework which 
passes the information on to the UserSerializer for validation.  Serializers in DRF inherit from 
Django forms, so the errors we get back (if any) will look just like errors we might get back from 
an invalid Django form.  So we know that errors will come back as a Python dictionary, converted to 
a JSON object, e.g.:</p>
<div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;This field is required.&quot;</span><span class="p">}</span>
</pre></div>


<p>or </p>
<div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;non_field_errors&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid username or password&quot;</span><span class="p">}</span>
</pre></div>


<p>We are going to use these ideas to our advantage to submit form data to Django, and report back 
with any errors (like an invalid password).</p>
<p>So right now we have an AuthController that does nothing.  It has a "model" attribute, which we will 
use later on to represent the currently logged in user.  We are going to add a few more attributes 
to represent the form fields we need, the token we eventually get back, and any errors encountered 
while processing the login form.</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">AuthController</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectController</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">username</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">token</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">errors</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setProperties</span><span class="p">({</span>
            <span class="nx">username</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">password</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">errors</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">model</span><span class="o">:</span> <span class="kc">null</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>Let's look at the authentication handlebars template we'll be using:</p>
<div class="highlight"><pre><span class="nt">&lt;form</span> <span class="cp">{{</span><span class="nv">action</span> <span class="s1">&#39;login&#39;</span> <span class="nv">on</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span><span class="cp">}}</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="cp">{{</span><span class="nv">bind-attr</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;errors.username:has-error&#39;</span><span class="cp">}}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span&gt;</span><span class="cp">{{</span><span class="nv">errors.username</span><span class="cp">}}</span><span class="nt">&lt;/span&gt;</span>
        <span class="cp">{{</span><span class="nv">input</span> <span class="nv">value</span><span class="o">=</span><span class="nv">username</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;text&#39;</span> <span class="nv">placeholder</span><span class="o">=</span><span class="s1">&#39;Username&#39;</span><span class="cp">}}</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="cp">{{</span><span class="nv">bind-attr</span> <span class="nv">class</span><span class="o">=</span><span class="s1">&#39;errors.password:has-error&#39;</span><span class="cp">}}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span&gt;</span><span class="cp">{{</span><span class="nv">errors.password</span><span class="cp">}}</span><span class="nt">&lt;/span&gt;</span>
        <span class="cp">{{</span><span class="nv">input</span> <span class="nv">value</span><span class="o">=</span><span class="nv">password</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;password&#39;</span> <span class="nv">placeholder</span><span class="o">=</span><span class="s1">&#39;Password&#39;</span><span class="cp">}}</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{{</span><span class="err">#</span><span class="k">if</span> <span class="nv">errors.non_field_errors</span><span class="cp">}}</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;strong&gt;</span>Oops!<span class="nt">&lt;/strong&gt;</span> <span class="cp">{{</span><span class="nv">errors.non_field_errors</span><span class="cp">}}</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{{</span><span class="nv">input</span> <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span> <span class="nv">value</span><span class="o">=</span><span class="s1">&#39;Log in&#39;</span><span class="cp">}}</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>


<p>Easy: we have a username and password field bound to the AuthController, and a few areas of text 
that are bound to any potential errors we get back.  When the form is submitted, the "login" action 
is fired, so let's implement that in the controller:</p>
<div class="highlight"><pre><span class="p">...</span>
<span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">login</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api-token-auth/&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">token</span><span class="p">);</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">transitionToRoute</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></div>


<p>If the authentication request is successful, we'll reset the form (a function we'll implement later 
to just clear the fields of their old values), store the token, and navigate to the index (or 
wherever you want the user to go next).  If the authentication request is not successful, we'll 
populate the errors attribute so the user gets information on why the form was not valid.</p>
<p><strong>The tricky part!</strong>  After the authentication request to the API succeeds, we want to 
store the token permanently (so if the user refreshes the page, they are still logged in), <em>and</em> we 
want to make sure that any future API request includes the token in the header.  To accomplish the 
latter we'll implement functions in the AuthController to check for a valid token, setup future AJAX 
requests to use the token, retrieve the current user, and process a new token when it is set by a 
successful authentication form response:</p>
<div class="highlight"><pre><span class="p">...</span>
<span class="nx">hasValidToken</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">token</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">);</span>
<span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">),</span>
<span class="nx">setupAjax</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ajaxSend</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">hasValidToken</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Token &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">},</span>
<span class="nx">setCurrentUser</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasValidToken</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">currentUser</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;me&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="nx">currentUser</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nx">tokenChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">MYPROJECT_auth_token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setupAjax</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentUser</span><span class="p">();</span>
<span class="p">}.</span><span class="nx">observes</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<span class="p">...</span>
</pre></div>


<p>Here we have an observer that persists a new token to local storage, sets up future AJAX requests, 
and retrieves the currently logged in user.</p>
<h3>Retrieving tokens from local storage</h3>
<p>You'll notice above that we persist the token to local storage.  This is so the token is still 
available even if the user refreshes the page (or leaves and comes back, etc..)  We'll need to 
retrieve the token from local storage anytime the user visits the site, so create/modify 
ApplicationRoute to handle this.  While we're at it, we'll add a 'logout' action that can be 
accessed from anywhere in the site:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">ApplicationRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">MYPROJECT_auth_token</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">).</span><span class="nx">setupAjax</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">).</span><span class="nx">setCurrentUser</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">logout</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">App</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>If the user has not visited the site before, or has not authenticated, 
<code>localStorage.MYPROJECT_auth_token</code> will return <code>undefined</code>.</p>
<h3>Protected Routes</h3>
<p>Invariably, there will be some routes you do not want unauthenticated users to access.  We'll 
create a base route that covers these:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">RestrictedRoute</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">beforeModel</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">controllerFor</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">).</span><span class="nx">hasValidToken</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>And all other protected routes will extend this, e.g.:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">MySecretRoute</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">RestrictedRoute</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span> <span class="err">…</span>
</pre></div>


<h3>Tying it all together</h3>
<p>So now we have an AuthController, an auth template, and a few modifications to our routes.  All 
that's remaining is creating the actual login page, and a way to get to it.  In your router:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">Router</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/login&#39;</span> <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>This will use the auth template and controller we already created, now we just need part of the 
main application template to provide information about the logged in user, or provide a link to 
the login page if the user is not yet logged in.  To do this we'll need to make the AuthController 
available to the main application template.  So create/modify ApplicationController:</p>
<div class="highlight"><pre><span class="nx">App</span><span class="p">.</span><span class="nx">ApplicationController</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">needs</span><span class="o">:</span> <span class="s1">&#39;auth&#39;</span>
<span class="p">});</span>
</pre></div>


<p>And now in your main application handlebars template:</p>
<div class="highlight"><pre><span class="cp">{{</span><span class="err">#</span><span class="k">with</span> <span class="nv">controllers.auth</span><span class="cp">}}</span>
<span class="cp">{{</span><span class="err">#</span><span class="k">if</span> <span class="nv">hasValidToken</span><span class="cp">}}</span>
Welcome back, <span class="cp">{{</span><span class="nv">first_name</span><span class="cp">}}</span> <span class="cp">{{</span><span class="nv">last_name</span><span class="cp">}}</span>!
<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="cp">{{</span><span class="nv">action</span> <span class="s1">&#39;logout&#39;</span><span class="cp">}}</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;</span>
<span class="cp">{{</span><span class="k">else</span><span class="cp">}}</span>
<span class="cp">{{</span><span class="err">#</span><span class="nv">link-to</span> <span class="s1">&#39;auth&#39;</span><span class="cp">}}</span>Login<span class="cp">{{</span><span class="o">/</span><span class="nv">link-to</span><span class="cp">}}</span>
<span class="cp">{{</span><span class="o">/</span><span class="k">if</span><span class="cp">}}</span>
<span class="cp">{{</span><span class="o">/</span><span class="k">with</span><span class="cp">}}</span>
</pre></div>


<h2>Conclusion</h2>
<p>Everything above, when put together, will provide you with a token-based authentication scheme for 
your API server, and a way to consume it using Ember.  Token-based authentication is nice because 
it is straight-forward for other API consumers to plug into quickly without having to worry about 
cookies and such.  Think mobile applications.</p>
<p>Remember, the initial request to retrieve a token sends a plain text username and password across 
the net, and all subsequent requests send a naked token across the net.  Always use SSL when using 
token-based authentication.</p>
            <a href="#" class="go-top">Go Top</a>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = "dustinfarris"; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
<footer class="footer">
    <p>&copy; Dustin Farris &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure-single">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
    </div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-13275015-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>

</body>
</html>