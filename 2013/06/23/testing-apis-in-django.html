<!doctype html>

<html lang="en">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1">
<link rel="alternate"  href="http://dustinfarris.com/feeds/all.atom.xml" type="application/atom+xml" title="Dustin Farris Full Atom Feed">
<title>Testing APIs in Django</title>
<script>
WebFontConfig = {
google: { families: [ 'Dosis:600:latin', 'Open+Sans:400italic,400,700:latin' ] }
};
(function() {
 var wf = document.createElement('script');
 wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
 '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
 wf.type = 'text/javascript';
 wf.async = 'true';
 var s = document.getElementsByTagName('script')[0];
 s.parentNode.insertBefore(wf, s);
 })();
</script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
<link rel="stylesheet" href="http://dustinfarris.com/theme/css/pure.css"><link rel="stylesheet" href="http://dustinfarris.com/theme/css/pygments.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta
name="description"
content="Dustin Farris">
<link href="http://dustinfarris.com/humans.txt" rel="author">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
<div class="pure-g-r" id="layout">
<div class="sidebar pure-u">
  <div class="cover-img" style="background-image: url('http://dustinfarris.com/images/beach.jpg')">
    <div class="cover-body">
      <header class="header">
        <hgroup>
        <a href="http://dustinfarris.com">
          <img class="avatar" src="http://dustinfarris.com/images/dustin.jpeg">
        </a>
        <h1 class="brand-main"><a href="http://dustinfarris.com">Dustin Farris</a></h1>
        <p class="tagline">inveniam viam aut faciam</p>
        <p class="social">
        <a href="https://github.com/dustinfarris/">
          <i class="fa fa-github fa-3x"></i>
        </a>
        <a href="https://twitter.com/dustinfarris">
          <i class="fa fa-twitter fa-3x"></i>
        </a>
        <a href="/feeds/all.atom.xml">
          <i class="fa fa-rss fa-3x"></i>
        </a>
        </p>
        </hgroup>
      </header>
    </div>
  </div>
</div><div class="pure-u">
  <div class="content">
    <article
      class="post"
      role="main"
      itemscope
      itemprop="mainContentOfPage"
      itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
        <h1 itemprop="name">Testing APIs in Django</h1>
        <div class="lead" itemprop="description"><p>I think anyone who has got their hands more than slightly wet with functional testing knows the pain of testing code that relies on API calls.  The usual suspects can bring your tests to a screeching halt: your network is down, the API is down, the API changed.  While knowing ...</p></div>
      </header>
      <footer>
        <p class="post-meta">
        <a class="post-tag" href="http://dustinfarris.com/tag/django.html">Django</a>
        </p>
      </footer>
      <div itemprop="articleBody">
        <p>I think anyone who has got their hands more than slightly wet with functional testing knows the pain of testing code that relies on API calls.  The usual suspects can bring your tests to a screeching halt: your network is down, the API is down, the API changed.  While knowing about any of the above is important, you likely don't want a flood of emails every time the API you use has a hiccup.</p>
<p>Python has a few solutions to this problem.  The one I am using is also one of the simplest: <a href="https://github.com/kevin1024/vcrpy">VCR.py</a>.  It wraps any code you like and listens for HTTP requests.  It records the responses to these requests to a file and then uses the file instead of the actual HTTP request going forward.  Awesome.</p>
<p>Not only does this eliminate the annoying test failures, it also speeds up the test suite overall.  Two wins for the price of one.</p>
<h2>What about Behavioral Tests?</h2>
<p>Excellent question.  Turns out wrapping Selenium tests in VCR is not a good idea because it records <em>everything</em> that is communicated over HTTP.  For Selenium that means every page request to the browser, session cookie transmission, etc..  Solution?  A little get method to replace requests.get.</p>
<p>First a few extra settings in <code>test_settings.py</code>:</p>
<div class="highlight"><pre><span class="n">VCR_PATH</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">TEST_DIR</span><span class="p">,</span> <span class="s">&#39;fixtures&#39;</span><span class="p">,</span> <span class="s">&#39;responses.yaml&#39;</span><span class="p">)</span>
<span class="n">USE_VCR</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>


<p>And a get function in <code>myproject/http.py</code></p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">vcr</span>


<span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrap HTTP requests with VCR if we are testing.&quot;&quot;&quot;</span>
    <span class="n">use_vcr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;USE_VCR&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_vcr</span><span class="p">:</span>
        <span class="n">vcr</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">VCR_PATH</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_vcr</span><span class="p">:</span>
        <span class="n">vcr</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<p>Use this method from now on anywhere you would ordinarily use requests.get.</p>
      </div>
    </article>
    <a href="#" class="go-top">&uparrow;</a>
    <div class="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = "dustinfarris"; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
<footer class="footer">
  <p>&copy; Dustin Farris</p>
</footer>  </div>
</div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script>
var $top = $('.go-top');

// Show or hide the sticky footer button
$(window).scroll(function() {
    if ($(this).scrollTop() > 200) {
    $top.fadeIn(200);
    } else {
    $top.fadeOut(200);
    }
    });

// Animate the scroll to top
$top.click(function(event) {
    event.preventDefault();
    $('html, body').animate({scrollTop: 0}, 300);
    })

// Makes sure that the href="#" attached to the <a> elements
// don't scroll you back up the page.
$('body').on('click', 'a[href="#"]', function(event) {
    event.preventDefault();
    });
</script><script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js">
</script>
<script>
$(document).ready(function(){
  $(".content").fitVids();
});
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-13275015-1', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>